# 验证码识别
验证码识别系统设计与实现(PKU数算实习大作业)

编程语言与工具：python3  tensorflow库和captcha库

阶段1：算法搭建与模型训练

阶段2：实验结果测试与评估

阶段3: 完成实验报告

### 1.主要算法概述

本程序中使用深度学习破解验证码，不分割验证码，而是把验证码作为一个整体进行识别。利用深度学习算法破解字符验证码，使用生成训练数据以及大量计算力，在短时间内训练出验证码破解模型。核心算法采用了CNN（卷积神经网络）算法。

#### 1.1 深度学习算法：CNN（卷积神经网络）

验证码问题可以归结为一个图像分类的问题，图像识别对于人类来说是一个最基本的技能，但是对于机器来说这是很苦难的。对于人类来说的一张”图像“，对于机器来说只能是一连串的二进制01序列：一些头部字节以及对应于图像的像素矩阵，这是计算机能够获得的唯一输入。CNN提供了一种提供给计算机一个相对应于图像数组后，输出描述该图像属于某一特定分类的概率的数字的方法。

CNN的核心思想在于逐层地寻找一张图像的基本特征（低层级的诸如边缘、曲线，稍高层级的诸如爪子、四肢等）来进行对图像的归类。
本程序的神经网络使用了三层卷积层。

卷积层：层中会生成多个卷积核，卷积核类似于一个过滤器，通过经由训练生成的张量与输入的图像像素信息张量进行卷积操作(convolution)，得到一个输出张量。这样的操作有如下特点：不同的过滤器可以被看作是特征标识符。特征诸如边缘直线、曲线等。过滤器拥有特殊的像素结构，使得在于输入的图像中有类似特征的像素张量做卷积时会拥有更高的数值。如果说在输入后通过卷积得到了一个较高数值，那么就有理由认为这个图像拥有相似的结构，从而“激活”了过滤器。通过设置多层的卷积层，神经网络可以检测更为高级的特征。

激励层：用于赋予输出非线性性的。本程序中使用的非线性激活函数是sigmoid : 。 其中z是一个线性组合。Sigmoid函数的功能是相当于把一个实数压缩至0到1之间，这样一类就可以把激活函数看作一种“分类的概率”。

池化层：两个目的，一是减少了权重参数，降低计算成本；二是控制过拟合现象。在得到通过了激励层的输入后（这里会有某一个被激活了的过滤器对应的特征），被检测到的特征相对于其它特征的相对位置比其绝对位置重要，通过常见的最大池化或者平均池化，就可以达到上述两个目的。

Dropout层：主要目的为控制过拟合。Dropout 层将丢弃该层中一个随机的激活参数集，即在前向通过中将这些激活参数集设置为 0。 在某种程度上，这种机制强制网络变得更加冗余。这里的意思是：该网络将能够为特定的样本提供合适的分类或输出，即使一些激活参数被丢弃。此机制将保证神经网络不会对训练样本过于匹配，这将帮助缓解过拟合问题。

全连接层：运用于检测出高级特征之后。 在观察上一层抽取出的高级特征之后确定该图像与哪一种类型更为符合。在处理从卷积层（或者是激励层，池化层）的输入之后输出一个N维向量，其代表对应着分类数N的一个概率向量。

卷积核以及最后的全连接层需要通过训练得到，计算机通过反向传播的训练过程来调整过滤器值（权重）。反向传播分为四个部分，分别是前向传导、损失函数、后向传导，以及权重更新。在最开始，随机生成卷积核，这样的卷积核无法寻找出图像的低级特征，因此得到的输出是不合理的分类，这时候根据输出以及训练集的数值确定与真实值的偏移，也就是确定损失函数（常见的损失函数有均方误差等），确定哪部分因子直接导致了神经网络的损失，通过一些微积分方法，逐次减少损失（更新权重）。这四个步骤合为一个完整的学习周期，对于初始的训练图像，经过一段时间的训练，使得最后的正确率达到可观的数值。

#### 1.2 程序流程（系统分析与设计）

程序包含两个文件分别为A.py（生成验证码文件）和B.py（训练模型并测试文件）。

A.py主要用于构建字符集生成验证码矩阵和验证码文本，必要时可用于查看具体验证码图片(60*160)效果。

B.py主要分为基础函数，CNN算法函数以及测试函数三部分。基础函数包括图片转灰度矩阵，文本转向量，向量转文本以及生成训练样本集；CNN算法函数部分包括CNN算法和训练算法；测试函数部分包括多次测试以及单点测试。每一部分函数的详细功能在代码实现中都有详细注释。主函数为训练加测试。

程序运行前先设置成功率或总步数，如90%或50000步，当训练时的正确率大于等于90%或步数超过50000步时训练结束，并将此模型保存在特定目录下。训练时每100步进行一次正确率测试，即随机生成100个验证码样本进行验证。

得到所需模型后进行模型测试，取出特定目录下的保存的模型，进行多次或单次测试得到实际成功率。在程序中用1000个验证码样本进行验证：随机生成验证码进行预处理（灰度化，一维化）,将预测结果和正确结果进行比对，循环1000次。

### 2.运行情况分析

#### 2.1训练模型

成功率：

1. 达到50%成功率平均需要约3500个批次，总计35w张图片。

2. 达到90%成功率需要约25000个批次，总计200w张图片。

3. 达到94%成功率需要约50000个批次，总计500w张图片。

#### 2.2测试模型

1. 50%成功率模型测试后的实际成功率：8%

2. 90%成功率模型测试后的实际成功率：55%

3. 94%成功率模型测试后的实际成功率：76%

（PS：虽然实际成功率和理论成功率有偏差，但是只要训练样本数上去了，还是能得到成功率很高的模型）

### 3.评估分析

1.过拟合现象虽经过处理，但仍有一定影响，导致在测试时对样本拟合程度好而在实际测试时拟合程度没有原来好，从而导致了测试成功率和实际成功率的不一致现象，这一现象在50%样本的模中尤为显著。

2.计算能力不足，时间有限。Mac运行时使用CPU计算，训练速度慢，训练50000样本的模型总计花了50多小时；Windows使用GPU计算，训练速度稍快，训练5w样本的模型总计花了11个小时。若是要获得90%以上的实际正确率模型，预计需要100w个样本进行训练，但是由于计算能力实在有限以及时间限制等原因，最高只训练了5w样本的模型。

### 4.总结与反思

通过本次验证码识别大作用，我们对深度学习有了初步了解，特别是对卷积深度神经网络的理论和应用有了进一步的学习。原来黑匣子一样的人工智能算法在我们看来开始有了一定的轮廓，除了一些特定的细节问题，我们对卷积神经网络的工作原理及算法大致思路有了一定的认识。本次作业中值得反思的一点是就提高训练速度以及处理过拟合问题没能得到进一步的处理。训练速度是硬件问题，下次可以考虑利用服务器的云计算能力（如腾讯云等）；过拟合问题因为时间关系没能进一步测试处理算法细节，下次可以尝试同时训练测试多个过拟合处理版本算法。


